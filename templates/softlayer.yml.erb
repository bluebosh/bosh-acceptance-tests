---
name: <%= properties.name || "bat" %>

releases:
  - name: bat
    version: <%= properties.release || "latest" %>

compilation:
  workers: 1
  network: default
  reuse_compilation_vms: true
  cloud_properties:
    cpu: 4
    memory: 8192
    max_network_speed: 10
    ephemeral_disk_size: 100
    datacenter: <%= properties.cloud_properties.datacenter %>
    hostname_prefix: bat-softlayer-worker
    domain: softlayer.com
    hourly_billing_flag: true
    local_disk_flag: false

update:
  canaries: <%= properties.canaries || 1 %>
  canary_watch_time: 3000-90000
  update_watch_time: 3000-90000
  max_in_flight: <%= properties.max_in_flight || 1 %>
  serial: true

networks:
<% properties.networks.each do |network| %>
- name: <%= network.name %>
  type: dynamic
  dns: <%= properties.dns %>
  cloud_properties:
    vlan_ids: <%= network.cloud_properties.vlan_ids %>
<% end %>

resource_pools:
  - name: common
    network: default
    size: <%= properties.pool_size %>
    stemcell:
      name: <%= properties.stemcell.name %>
      version: '<%= properties.stemcell.version %>'
    cloud_properties:
      cpu: 4
      memory: 8192
      max_network_speed: 10
      ephemeral_disk_size: 100
      datacenter: <%= properties.cloud_properties.datacenter %>
      hostname_prefix: <%= properties.cloud_properties.hostname_prefix %>
      domain: <%= properties.cloud_properties.domain %>
      hourly_billing_flag: true
      local_disk_flag: false
    <% if properties.password %>
    env:
      bosh:
        password: <%= properties.password %>
        keep_root_password: true
    <% end %>

jobs:
  - name: <%= properties.job || "batlight" %>
    templates: <% (properties.templates || ["batlight"]).each do |template| %>
    - name: <%= template %>
    <% end %>
    instances: <%= properties.instances %>
    resource_pool: common
    <% if properties.persistent_disk %>
    persistent_disk: <%= properties.persistent_disk %>
    <% end %>
    networks:
      - name: default

properties:
  batlight:
    <% if properties.batlight.fail %>
    fail: <%= properties.batlight.fail %>
    <% end %>
    <% if properties.batlight.missing %>
    missing: <%= properties.batlight.missing %>
    <% end %>
    <% if properties.batlight.drain_type %>
    drain_type: <%= properties.batlight.drain_type %>
    <% end %>
